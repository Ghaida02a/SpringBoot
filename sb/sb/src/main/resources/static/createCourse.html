<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Add Course</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="styles.css">
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        nav a { margin-right: 10px; }
        label { display: block; margin-top: 10px; }
        input { width: 300px; padding: 5px; }
        button { margin-top: 15px; padding: 10px 20px; }
        pre { background: #f4f4f4; padding: 10px; border: 1px solid #ccc; }
        .success { color: green; }
        .error { color: red; }
    </style>
</head>
<body>
<nav>
    <a href="index.html">üè† Home</a>
    <a href="createCourse.html">‚ûï Add Course</a>
    <a href="updateCourse.html">‚úèÔ∏è Update Course</a>
    <a href="getCourseById.html">üîç Get Course By ID</a>
    <a href="deleteCourse.html">üóëÔ∏è Delete Course</a>
    <a href="getAllCourses.html">üìã View All Courses</a>
</nav>

<h1>Add a Course</h1>
<form id="courseForm">
    <label for="name">Course Name:</label>
    <input type="text" id="name" name="name" />

    <label for="hours">Course Hours:</label>
    <input type="number" id="hours" name="hours" step="0.5" />

    <h3>Instructor Information:</h3>
    <label for="instructorId">Existing Instructor ID (optional):</label>
    <input type="number" id="instructorId" name="instructorId" />

    <p><em>OR create a new instructor:</em></p>

    <label for="instructorName">Instructor Name:</label>
    <input type="text" id="instructorName" name="instructorName" />

    <label for="instructorEmail">Instructor Email:</label>
    <input type="email" id="instructorEmail" name="instructorEmail" />

    <label for="instructorPhone">Instructor Phone:</label>
    <input type="text" id="instructorPhone" name="instructorPhone" />

    <label for="instructorDesignation">Instructor Designation:</label>
    <input type="text" id="instructorDesignation" name="instructorDesignation" />

    <h3>Department Information:</h3>
    <label for="departmentId">Existing Department ID (optional):</label>
    <input type="number" id="departmentId" name="departmentId" />

    <p><em>OR create a new department:</em></p>

    <label for="departmentName">Department Name:</label>
    <input type="text" id="departmentName" name="departmentName" />

    <h3>Add Marks:</h3>
    <div id="marksContainer">
        <div class="mark-entry">
            <label>Student Name:</label>
            <input type="text" class="studentName" placeholder="Student Name" />
            <label>Score:</label>
            <input type="number" class="score" placeholder="Score" step="0.1" />
        </div>
    </div>
    <button type="button" onclick="addMarkField()">‚ûï Add Another Mark</button>

    <button type="submit">Create Course</button>
    <button type="button" onclick="refreshForm()">üîÑ Refresh</button>
</form>

<h3>Response:</h3>
<pre id="response"></pre>

<script>
    const form = document.getElementById("courseForm");
    const responseBox = document.getElementById("response");

    // Function to add more mark fields
    function addMarkField() {
      const marksContainer = document.getElementById("marksContainer");
      const newMarkEntry = document.createElement("div");
      newMarkEntry.className = "mark-entry";
      newMarkEntry.style.marginTop = "10px";
      newMarkEntry.innerHTML = `
        <label>Student Name:</label>
        <input type="text" class="studentName" placeholder="Student Name" />
        <label>Score:</label>
        <input type="number" class="score" placeholder="Score" step="0.1" />
        <button type="button" onclick="this.parentElement.remove()">‚ùå Remove</button>
      `;
      marksContainer.appendChild(newMarkEntry);
    }

    form.addEventListener("submit", async (e) => {
      e.preventDefault();

      const name = document.getElementById("name").value;
      const hours = parseFloat(document.getElementById("hours").value);

      // Instructor data
      const instructorId = document.getElementById("instructorId").value
        ? parseInt(document.getElementById("instructorId").value)
        : null;
      const instructorName = document.getElementById("instructorName").value;
      const instructorEmail = document.getElementById("instructorEmail").value;
      const instructorPhone = document.getElementById("instructorPhone").value;
      const instructorDesignation = document.getElementById("instructorDesignation").value;

      // Department data
      const departmentId = document.getElementById("departmentId").value
        ? parseInt(document.getElementById("departmentId").value)
        : null;
      const departmentName = document.getElementById("departmentName").value;

      // Collect all marks
      const markEntries = document.querySelectorAll(".mark-entry");
      const marks = [];
      markEntries.forEach(entry => {
        const studentName = entry.querySelector(".studentName").value;
        const score = parseFloat(entry.querySelector(".score").value);
        if (studentName && !isNaN(score)) {
          marks.push({
            studentName: studentName,
            score: score
          });
        }
      });

      // Build payload
      const payload = {
        name: name,
        hours: hours,
        instructorId: instructorId,
        departmentId: departmentId,
        marks: marks
      };

      // Add instructor object if new instructor data is provided
      if (instructorName && instructorEmail && instructorPhone && instructorDesignation) {
        payload.instructor = {
          name: instructorName,
          email: instructorEmail,
          phoneNumber: instructorPhone,
          designation: instructorDesignation
        };
      }

      // Add department object if new department data is provided
      if (departmentName) {
        payload.department = {
          name: departmentName
        };
      }

      console.log("Sending payload:", JSON.stringify(payload, null, 2));

      try {
        const res = await fetch("http://localhost:8080/courses/addFullCourse", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload)
        });

        console.log("Response status:", res.status);
        console.log("Response ok:", res.ok);

        if (res.ok) {
          const data = await res.json();
          console.log("Success response:", data);
          responseBox.textContent = JSON.stringify(data, null, 2);
          responseBox.className = "success";
        } else {
          // Try to get error response as text first
          const errorText = await res.text();
          console.log("Error response text:", errorText);
          try {
            // Try to parse as JSON for better formatting
            const errorData = JSON.parse(errorText);
            responseBox.textContent = JSON.stringify(errorData, null, 2);
          } catch {
            // If not JSON, display as plain text
            responseBox.textContent = errorText;
          }
          responseBox.className = "error";
        }

        responseBox.style.display = "block";
      } catch (err) {
        console.error("Fetch error:", err);
        responseBox.textContent = "Error creating course: " + err;
        responseBox.className = "error";
        responseBox.style.display = "block";
      }
    });

    function refreshForm() {
      form.reset();
      responseBox.style.display = "none";
      // Reset to one mark entry
      const marksContainer = document.getElementById("marksContainer");
      marksContainer.innerHTML = `
        <div class="mark-entry">
            <label>Student Name:</label>
            <input type="text" class="studentName" placeholder="Student Name" />
            <label>Score:</label>
            <input type="number" class="score" placeholder="Score" step="0.1" />
        </div>
      `;
    }
</script>
</body>
</html>
